# V4.0.0 — Change Tracking

This document tracks the major and breaking changes being made in the V4.0.0 refactoring branch. It is intended as a working reference during development, not a user-facing release note.

---

## Breaking Changes

### 1. `proto.Message` replaced by `any` across the public API

All public methods that previously required `google.golang.org/protobuf/proto.Message` now accept `any`. This affects every message-passing surface in the system:

| Surface                                                   | Old signature                   | New signature         |
|-----------------------------------------------------------|---------------------------------|-----------------------|
| `PID.Tell`                                                | `message proto.Message`         | `message any`         |
| `PID.Ask`                                                 | `message proto.Message`         | `message any`         |
| `PID.PipeTo` / `PipeToName` task                          | `func() (proto.Message, error)` | `func() (any, error)` |
| `ActorSystem.Schedule` / `ScheduleOnce`                   | `message proto.Message`         | `message any`         |
| `ActorSystem.RemoteSchedule` / `RemoteScheduleOnce`       | `message proto.Message`         | `message any`         |
| `ActorSystem.ScheduleWithCron` / `RemoteScheduleWithCron` | `message proto.Message`         | `message any`         |
| `ActorSystem.AskGrain`                                    | `message proto.Message`         | `message any`         |
| `ActorSystem.TellGrain`                                   | `message proto.Message`         | `message any`         |
| `ActorSystem.handleRemoteAsk`                             | `message proto.Message`         | `message any`         |
| `ActorSystem.handleRemoteTell`                            | `message proto.Message`         | `message any`         |

**Migration:** Replace `proto.Message` type constraints in actor `Receive` handlers and call sites with plain `any`. Serialization is now handled by the new `remote.Serializer` layer (see below).

---

### 2. `goaktpb` package removed

The top-level `goaktpb` package (`goaktpb/goakt.pb.go`, `protos/goakt/goakt.proto`) has been deleted. All system-defined message types that lived in it are now plain Go structs in the `actor` package.

**Migration:** Remove any imports of `github.com/tochemey/goakt/v3/goaktpb`. Use the equivalent types from `github.com/tochemey/goakt/v3/actor` instead.

| Old (`goaktpb`)             | New (`actor`)             |
|-----------------------------|---------------------------|
| `goaktpb.PostStart`         | `actor.PostStart`         |
| `goaktpb.PoisonPill`        | `actor.PoisonPill`        |
| `goaktpb.Terminated`        | `actor.Terminated`        |
| `goaktpb.Deadletter`        | `actor.Deadletter`        |
| `goaktpb.NoMessage`         | `actor.NoMessage`         |
| `goaktpb.ActorStarted`      | `actor.ActorStarted`      |
| `goaktpb.ActorStopped`      | `actor.ActorStopped`      |
| `goaktpb.ActorPassivated`   | `actor.ActorPassivated`   |
| `goaktpb.ActorChildCreated` | `actor.ActorChildCreated` |
| `goaktpb.ActorRestarted`    | `actor.ActorRestarted`    |
| `goaktpb.ActorSuspended`    | `actor.ActorSuspended`    |
| `goaktpb.ActorReinstated`   | `actor.ActorReinstated`   |
| `goaktpb.NodeJoined`        | `actor.NodeJoined`        |
| `goaktpb.NodeLeft`          | `actor.NodeLeft`          |

Constructor functions (e.g. `actor.NewDeadletter(...)`, `actor.NewActorStarted(...)`) replace direct protobuf struct literals. Timestamps are now `time.Time` rather than `*timestamppb.Timestamp`.

---

### 3. Internal protobuf files removed

Two internal protobuf definitions that were used only for event delivery have been deleted:

- `protos/internal/deadletter.proto` / `internal/internalpb/deadletter.pb.go`
- `protos/internal/healthcheck.proto` / `internal/internalpb/healthcheck.pb.go`

Their payloads are now native Go structs (see above).

---

### 4. `supervisionSignal` decoupled from protobuf

`supervisionSignal.msg` changed from `proto.Message` to `any`, and `supervisionSignal.timestamp` changed from `*timestamppb.Timestamp` to `time.Time` (UTC). The `Msg()` and `Timestamp()` accessor return types follow accordingly. This is an internal type, but any code that reached into supervision internals must be updated.

---

### 5. Cluster event payload type changed

`internal/cluster.Event.Payload` changed from `*anypb.Any` to `any`. Two concrete typed event structs have been introduced to replace protobuf-wrapped cluster events:

```go
// internal/cluster
type NodeJoinedEvent struct {
    Address   string
    Timestamp time.Time
}

type NodeLeftEvent struct {
    Address   string
    Timestamp time.Time
}
```

---

## New Additions

### 6. `actor/messages.go` — native Go system messages

All system message types are now defined as plain Go structs with accessor methods and constructor functions. The full set includes:

- Lifecycle: `PostStart`, `PoisonPill`, `Terminated`, `NoMessage`, `PanicSignal`
- Actor events: `ActorStarted`, `ActorStopped`, `ActorPassivated`, `ActorChildCreated`, `ActorRestarted`, `ActorSuspended`, `ActorReinstated`
- Deadletter: `Deadletter`
- Cluster events: `NodeJoined`, `NodeLeft`

Each type carries a `time.Time` timestamp set at construction (UTC).

---

### 7. `actor/messages_serializers.go` — serialization support for native types

Provides `encoding`/serialization support for the native message types defined in `actor/messages.go`, so they can cross process boundaries over the remoting layer without requiring protobuf.

---

### 8. `remote/serializer.go` — pluggable serializer interface

A new `Serializer` interface decouples the remoting wire format from protobuf:

```go
type Serializer interface {
    Serialize(v any) ([]byte, error)
    Deserialize(data []byte) (any, error)
}
```

Implementations must be self-describing (the serialized bytes must embed enough type information for `Deserialize` to reconstruct the original concrete type without out-of-band coordination).

---

### 9. `remote/proto_serializer.go` — built-in protobuf implementation

The default `Serializer` implementation for protobuf messages. Used automatically when the message type implements `proto.Message`.

---

### 10. `remote/serializer_dispatch.go` — type-based serializer dispatch

Dispatches to the correct `Serializer` based on the runtime type of the message, allowing native Go structs and protobuf messages to coexist on the same remoting layer.

---

### 11. `internal/commands` package

A new `internal/commands` package provides the internal command abstraction previously implemented inline in `pid.go` and `actor_system.go`. Extracted to reduce coupling and improve testability of the actor lifecycle machinery.

---

## Internal Improvements

### 12. `address.Address.String()` — eager caching

`cachedStr` is now computed once inside the `New` and `NewWithParent` constructors rather than lazily on the first `String()` call. This makes `String()` a pure, safe concurrent read with zero branching and eliminates the one-time write-race window that existed under the lazy approach.

---

### 13. `internal/xsync.List` — deduplication and low-GC redesign

The generic list type gained several improvements:

- Type parameter tightened from `any` to `comparable`, enabling built-in deduplication.
- `Append` and `AppendMany` are now no-ops for items already present.
- New `Contains(item T) bool` method.
- Pre-allocated backing array (`cap=4`) to avoid the first resize on small lists.
- Cleared slots are zeroed immediately on `Reset` to prevent pointer/interface values from blocking GC.
- `Get` accesses the element while holding the read lock, preventing a concurrent reallocation from invalidating a bounds check that was performed before the lock.
